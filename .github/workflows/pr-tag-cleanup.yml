name: Cleanup PR moving tag

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  cleanup:
    if: github.event.pull_request.merged == true
      && github.event.pull_request.base.ref == 'master'
      && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Delete moving tag for merged PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request.number;
            const headRef = context.payload.pull_request.head.ref;

            const safe = headRef
              .toLowerCase()
              .replace(/[^a-z0-9._-]+/g, "-")
              .replace(/-+/g, "-")
              .replace(/^-|-$/g, "");

            const tagName = `pr-${pr}-${safe}`;

            try {
              await github.rest.git.deleteRef({ owner, repo, ref: `tags/${tagName}` });
              core.info(`Deleted tag: ${tagName}`);
            } catch (e) {
              if (e.status === 404) core.info(`Tag not found: ${tagName}`);
              else throw e;
            }

