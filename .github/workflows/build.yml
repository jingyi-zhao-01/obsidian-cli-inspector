name: Release

on:
  push:
    branches:
      - master

concurrency:
  group: release-master
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_TOOLCHAIN: 1.87.0

jobs:
  release:
    name: Release to crates.io
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      # IMPORTANT: capture the previous tag BEFORE creating/pushing the new tag
      - name: Determine previous tag
        id: prev_tag
        run: |
          PREV_TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          echo "PREV_TAG=${PREV_TAG}" >> $GITHUB_OUTPUT

      - name: Create next version tag (creates + pushes)
        id: create_tag
        run: |
          TAG_LINE="$(./cicd/generate_tag.sh)"
          TAG="${TAG_LINE#TAG=}"
          VERSION="${TAG#v}"
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Install git-cliff
        run: cargo install git-cliff --locked

      - name: Generate semantic release notes (Conventional Commits)
        id: release_notes
        run: |
          PREV="${{ steps.prev_tag.outputs.PREV_TAG }}"
          TAG="${{ steps.create_tag.outputs.TAG }}"

          if [ -z "$PREV" ]; then
            git cliff -- --conventional --tag "$TAG" -o release_notes.md
          else
            git cliff -- --conventional "$PREV..HEAD" --tag "$TAG" -o release_notes.md
          fi

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.TAG }}
          body_path: release_notes.md

