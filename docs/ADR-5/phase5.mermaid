---
title: Phase 5 - Query Layer (Basic Retrieval)
config:
  theme: 'forest'
---
flowchart TD
    start(["Start: query command"]) --> parse["Parse CLI args"]
    parse --> connect["Open database connection"]
    connect --> route{"Select query type"}

    route -- "Search" --> fts["FTS5 MATCH + BM25 ranking"]
    fts --> searchFmt["Format search results"]

    route -- "Backlinks" --> backlinks["Resolve dst_note_id -> src notes"]
    backlinks --> linkFmt["Format link results"]

    route -- "Forward links" --> forward["Resolve src_note_id -> dst notes"]
    forward --> linkFmt

    route -- "Unresolved" --> unresolved["Find links with dst_note_id IS NULL"]
    unresolved --> linkFmt

    route -- "Tags" --> tagMode{"Tag mode"}
    tagMode -- "List" --> listTags["SELECT DISTINCT tag"]
    tagMode -- "Single" --> byTag["Find notes by tag"]
    tagMode -- "AND" --> andTags["Intersect tags"]
    tagMode -- "OR" --> orTags["Union tags"]
    listTags --> tagFmt["Format tag results"]
    byTag --> tagFmt
    andTags --> tagFmt
    orTags --> tagFmt

    searchFmt --> done(["Output to CLI"]) 
    linkFmt --> done
    tagFmt --> done
